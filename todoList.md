## 專案管理 
| #   | 任務項目          | 說明                                               | 負責人 | 實作狀態 |
| --- | ----------------- | -------------------------------------------------- | ------ | -------- |
| M1   | github 管理       | 共同維護 main 分支，管理 PR/分支策略              | 共同   | 進行中   |
| M2   | CF 託管           | 設定 Cloudflare Pages + Workers，完成部署流程     |        | 未開始   |
| M3   | TODO List 管理    | 持續維護此清單，確保需求與實作同步                 | 劉柏言 | 進行中   |
| M4   | 前端畫面設計      | 設計更美觀的前端頁面，套用新設計稿                 | 黃湘紜 | 進行中   |

---

## 系統規劃 
| #   | 任務項目   | 說明                                               | 負責人 | 實作狀態 |
| --- | ---------- | -------------------------------------------------- | ------ | -------- |
| P1   | 使用者案例圖 | 畫出使用者與程式功能的關係                         | 劉柏言 | 已完成   |
| P2   | 類別圖     | 畫出程式中用到的物件與關聯                         | 劉柏言  | 已完成   |
| P3   | 系統架構圖 | 畫出前端 / Workers / D1 / GitHub 架構         | 劉柏言 | 已完成   |
| P4   | 序列圖     | 至少畫出一個完整流程（寄件或貨態查詢）的時間互動圖 |        | 未開始   |

---

## 首頁與角色主控台（新）
| #   | 任務項目                | 說明                                                                 | 負責人 | 實作狀態 |
| --- | ----------------------- | -------------------------------------------------------------------- | ------ | -------- |
| H1  | 首頁導覽調整           | 登出狀態只顯示「總覽 / 登入 / 註冊」，不直接顯示客戶/司機/管理按鈕   |        | 未開始   |
| H2  | 登入後導覽與主控台跳轉 | 依 user_class 顯示對應的「客戶 / 司機 / 倉儲 / 客服 / 管理」入口     |        | 未開始   |
| H3  | 客戶主控台版面         | 客戶登入後顯示四個主要功能按鈕（建立寄件、包裹追蹤、合約/月結、付款），版面調整 | 劉柏言 | 已完成   |
| H4  | 司機 / 倉儲 / 客服 / 管理主控台骨架 | 各角色主控台至少有基本選單與 placeholder                          |        | 未開始   |

---

## 使用者與權限模組
| #   | 任務項目                   | 說明                                                                                     | 負責人 | 實作狀態 |
| --- | -------------------------- | ---------------------------------------------------------------------------------------- | ------ | -------- |
| U1  | 使用者註冊 / 登入 API      | email/password、基本驗證，登入後發 token 並寫入前端狀態                                   | 劉柏言  | 已完成   |
| U2  | 角色權限 Middleware        | 依 user_class 限制 API 存取（客戶 / 司機 / 倉儲 / 客服 / 管理）                          |        | 擱置(等所有 API 大致完成) |
| U3  | 使用者資料表建立           | D1 schema：users 欄位（含 user_class、是否合約客戶等）                                   | 共同   | 已完成   |
| U4  | 預設帳號種子資料           | 在資料庫建立預設帳號（合約客戶、客服、司機、倉儲員、管理員）                             | 劉柏言 | 已完成  |
| U5  | 使用者支付偏好欄位         | 在 users 表中新增 preferred_payment_method                     | 劉柏言 | 已完成   |
| U6  | 支付偏好設定 UI & API      | 客戶可以在個人設定頁調整偏好支付方式，後端更新資料                                       | 劉柏言 | 已完成   |

---

## 客戶端：排程取件與寄件建立 + 運費計算
 
> 客戶主控台目前已有「排程取件」「建立寄件」兩個表單，但尚未串接後端 API。

| #   | 任務項目                      | 說明                                                                                 | 負責人 | 實作狀態 |
| --- | ----------------------------- | ------------------------------------------------------------------------------------ | ------ | -------- |
| S1  | 寄件預約資料表設計            | （已完成）儲存尺寸、重量、服務時效、特殊標記、備註等寄件需求                         | 共同   | 已完成   |
| S2  | 建立寄件 API（建立 package）  | 客戶在「建立寄件」填寄件人/收件人/尺寸/時效/付款方式，呼叫 API 建立 packages 記錄   | 劉柏言 | 已完成   |
| S3  | 運費規則資料表                | service_rules：尺寸 × 時效 × 特性 × 價格                                            |        | 未開始   |
| S4  | 運費計算服務（後端）          | 根據 service_rules 計算運費，獨立成可測試 function/service                          |        | 未開始   |
| S5  | 運費試算 API                  | 前端在建立寄件時可先試算，不一定立即建立訂單                                        |        | 未開始   | 
| S6  | 前端寄件相關表單串接          | 把「建立寄件」表單與 S5/S2 串起來（目前介面已初步完成，缺試算 & 建立 API 串接）      | 劉柏言 | 進行中 |
| S7  | 確認建立寄件訂單流程          | 流程：填表 → 試算 → 確認 → 建立 package + 對應帳單/付款資料                         |        | 未開始   |

---

## 貨態追蹤與事件紀錄

| #   | 任務項目                        | 說明                                                                                              | 負責人 | 實作狀態 |
| --- | ------------------------------- | ------------------------------------------------------------------------------------------------- | ------ | -------- |
| T1  | package 資料表設計              | 基本欄位：寄件人、收件人、狀態、追蹤碼等                                                          | 共同   | 已完成   |
| T2  | package_events 資料表           | 每個事件：時間、地點、類型（收件/出庫/入庫/派送中/簽收…）                                       | 共同   | 已完成   |
| T3  | 建立貨態事件 API                | 新增事件並更新當前狀態（共用內部服務，給司機/倉儲/客服/模擬使用）                                | 李天旭       | 完成   |
| T4  | 貨態查詢 API（含角色權限）      | 所有人皆可查貨態：客戶只能查自己的包裹；員工只能查與自己工作相關的包裹（司機路線、倉儲節點等）!現在沒辦法鑑權!   | 李天旭       | 完成   |
| T5  | 司機更新貨態 API                | 對司機開放的貨態更新端點（出發、已收件、已送達…），內部會呼叫 T3                               |        | 未開始   |
| T6  | 倉儲更新貨態 API                | 入庫、出庫、分揀事件 API，內部會呼叫 T3                                                          |        | 未開始   |
| T7  | 前端貨態查詢頁面                | 客戶主控台的「包裹追蹤」頁面：輸入追蹤碼 + 篩選條件（日期、狀態…），呼叫 T4                      |        | 介面完成 / 擱置(缺篩選 & API) |
| T8  | 前端事件時間軸 UI               | 將 package_events 顯示成時間線，供客戶 / 客服 / 管理檢視                                         |        | 未開始   |
| T9  | 員工可見包裹範圍規則定義        | 定義「司機 / 倉儲 / 客服 / 管理」各自可查詢的包裹範圍，並在 T4 中實作檢查                       |        | 未開始   |
| T10 | 鑑權與拒絕請求 API              | 讓用戶只能查到自己的包裹，並提供拒絕請求功能                                                        |        | 未開始   |
| T11 | 異常事件/申報/處理模型          | 定義「異常」事件類型、異常原因/說明、處理狀態（未處理/已處理）與處理報告，供司機/倉儲申報、客服處理 |        | 未開始   |
| T12 | 異常池資料表 migration          | 新增 `package_exceptions`：異常原因/說明、申報者、handled/handled_by/handled_at、處理報告與索引       |        | 未開始   |
| T13 | 異常申報/查詢/處理 API          | 司機/倉儲可申報異常；客服可查詢異常池（未處理/已處理）與標示已處理＋報告（串接 T11/T12）            |        | 未開始   |
| T14 | 司機任務資料表 migration        | 新增 `delivery_tasks`（或 staff_tasks）：task_type、from/to、assigned_driver、status、timestamps     |        | 未開始   |
| T15 | 司機車輛/位置資料表 migration   | 新增 `vehicles`（或 driver_state）：vehicle_code、home_node_id、current_node_id，支援地圖移動與起點 |        | 未開始   |
| T16 | 到付實收欄位/收費資料調整       | 擴充 `payments` 以支援司機到付實收（collected_amount/collected_at/collected_by...）並串接 D4        |        | 未開始   |
---

## 配送流程（虛擬地圖與模擬）

| #  | 任務項目              | 說明                                                         | 負責人 | 實作狀態 |
| -- | --------------------- | ------------------------------------------------------------ | ------ | -------- |
| V1 | 虛擬地圖節點設計      | 定義配送中心、配送站、超商、住家等節點與屬性                | 李天旭 | 完成   |
| V2 | 地圖資料模型與 API    | 建立節點、連線、距離/時間成本資料並提供讀寫 API            |  李天旭  | 進行中   |
| V3 | 配送路線模擬服務      | 依地圖與包裹資訊計算配送順序，模擬車輛沿路節點移動          | 劉柏言 | 進行中   |
| V4 | 前端地圖視覺化        | 在地圖上顯示節點與配送進度，可播放/暫停模擬                 | 劉柏言 | 進行中   |
| V5 | 模擬事件紀錄串接      | 將模擬路徑轉為 package_events，供貨態追蹤與展示使用         | 劉柏言 | 進行中   |

---

## 司機 / 配送端功能

| #   | 任務項目             | 說明                                                                 | 負責人 | 實作狀態 |
| --- | -------------------- | -------------------------------------------------------------------- | ------ | -------- |
| D1  | 工作指派/工作清單 API | 從貨態事件與/或任務表彙整「待取件/待配送/待轉運」任務；目前先支援單一司機帳號 |        | 未開始   |
| D2  | 司機工作清單頁面      | 列出任務：取件點/送達點/下一站、包裹列表、應收款、狀態；任務不強制順序，可點進任務操作 |        | 未開始   |
| D3  | 地圖移動（點選節點）  | 司機可選擇開車起始點（預設住家地址），在地圖上點選相鄰節點移動；不分區跑全圖 |        | 未開始   |
| D4  | 取件/送達（含收費）   | 在任務點位執行「已收件/已送達」並可輸入到付實收金額，寫入 payment + 貨態事件（T5/T3） |        | 未開始   |
| D5  | 貨物在車上所在地更新  | 包裹上車後，包裹所在地由原節點（住家/站點）改為「貨車編號」（或司機車輛 ID） |        | 未開始   |
| D6  | 司機異常申報          | 任務中可回報異常（無人收件、地址錯誤、損壞…），建立異常紀錄並將包裹狀態改為異常 |        | 未開始   |
| D7  | 任務狀態更新 API       | 任務 accept/in_progress/complete/cancel；完成時自動寫入貨態事件並推進 packages 狀態（串接 T14） |        | 未開始   |
| D8  | 司機車輛狀態/移動 API   | 取得車輛資訊（home/current/vehicle_code）與 move(to_node)；後端檢查 edges 相鄰（串接 T15） |        | 未開始   |
| D9  | 司機到付實收 API/串接   | 司機完成任務時可回報到付實收，寫入 payments（或新增收費紀錄）並回傳收費結果（串接 T16） |        | 未開始   |

---

## 倉儲端功能

| #   | 任務項目               | 說明                                                       | 負責人 | 實作狀態 |
| --- | ---------------------- | ---------------------------------------------------------- | ------ | -------- |
| W1  | 倉儲主控台頁面骨架     | 顯示本站待處理包裹、轉運中包裹與操作入口                    |        | 未開始   |
| W2  | 入站接收轉運包裹       | 包裹進到配送站時，將狀態設為「分揀轉運處理」並寫入事件（T6/T3） |        | 未開始   |
| W3  | 分揀完成/待轉運         | 分揀完成後將狀態設為「待貨車轉運」，並讓司機端重新產生/看到任務 |        | 未開始   |
| W4  | 決定下一次配送點/調整路徑 | 以系統計算路徑為建議，允許倉儲員修改包裹後續配送路徑（下一站/路徑序列） |        | 未開始   |
| W5  | 倉儲異常申報            | 入庫/分揀/轉運過程可申報異常，建立異常紀錄並將包裹狀態改為異常 |        | 未開始   |
| W6  | 倉儲改路徑 API           | 更新 `packages.route_path`（選配：新增 route override 留痕），供倉儲員修改後續配送路徑 |        | 未開始   |
| W7  | 倉儲異常申報 API         | 倉儲端建立異常紀錄（寫入 `package_exceptions`）並更新 packages/status + package_events |        | 未開始   |

---

## 客服後台

| #   | 任務項目                 | 說明                                                                     | 負責人 | 實作狀態 |
| --- | ------------------------ | ------------------------------------------------------------------------ | ------ | -------- |
| CS1 | 客服查詢貨態頁面         | 依多條件協助查詢貨物狀態（可用 T4 + 更多查詢條件）                      |        | 未開始   |
| CS2 | 異常池列表（未處理/已處理） | 當包裹狀態變更為異常時進入異常池；客服可篩選未處理/已處理                   |        | 未開始   |
| CS3 | 異常處理（標示已處理 + 報告） | 客服從異常池將未處理標示為已處理，填寫處理報告並保存                         |        | 未開始   |
| CS4 | 客服手動更新貨態功能     | 客服可手動輸入或更正配送狀態，寫入 package_events（呼叫 T3）                 |        | 未開始   |
| CS5 | 合約客戶申請審核介面     | 檢視客戶合約申請、核准/退回並更新 user_class、合約狀態                       |        | 未開始   |
| CS6 | 合約申請資料表與 API     | 客戶端送出的「合約/月結申請」表單資料 schema + 建立/查詢 API                 |        | 未開始   |
| CS7 | 異常池 API 串接           | 串接異常池查詢與處理 API（T13），完成前端列表、篩選、標示已處理與報告提交     |        | 未開始   |

---

## 管理員後台

| #  | 任務項目               | 說明                                                       | 負責人 | 實作狀態 |
| -- | ---------------------- | ---------------------------------------------------------- | ------ | -------- |
| A1 | 管理員後台首頁         | 查看系統概況：今日包裹數、未簽收數、錯誤事件等簡易 KPI    |        | 未開始   |
| A2 | 使用者管理介面         | 建立員工帳號、停用/刪除帳號、重設密碼                     |        | 未開始   |
| A3 | 管理員資料庫操作工具   | 管理員可直接查看與修改關鍵資料表（users/packages/events…） |        | 未開始   |
| A4 | 簡單統計報表           | 每日包裹數、各服務類型比例、各區域量體等（可選）          |        | 待討論   |
| A5 | 服務規則管理 UI        | 管理 service_rules（新增/修改/刪除運費規則），串接 S3     |        | 未開始   |

---

## 計費與月結帳單

> 這裡整合「預付/到付 → 帳單對象不同」與「支付方式偏好」的邏輯。

| #   | 任務項目                    | 說明                                                                                          | 負責人 | 實作狀態 |
| --- | --------------------------- | --------------------------------------------------------------------------------------------- | ------ | -------- |
| B1  | 付款資料表設計              | payments：金額、付款人、收費對象（寄件者/收件者）、方式（信用卡、匯款、貨到付款…）          | 共同   | 已完成   |
| B2  | 單筆寄件付款流程            | 若選「預付」→ 產生寄件者帳單；若選「到付」→ 產生收件者帳單，並根據使用者支付偏好決定支付流程 |        | 未開始   |
| B3  | 月結帳單資料表設計          | bills：合約客戶、計費期間、總金額等                                                           | 共同   | 已完成   |
| B4  | 月結帳單產生服務            | 依結帳週期彙總 packages → 建立 bills 與對應 payments                                         |        | 未開始   |
| B5  | 帳單查詢 API                | 合約客戶查詢各期帳單與明細                                                                   |        | 未開始   |
| B6  | 前端帳單列表頁              | 合約客戶在「合約 / 月結」頁面看到每期帳單與連結到明細                                       |        | 未開始   |
| B7  | 客戶付款頁面與流程（前端）  | 客戶主控台「付款」頁面：列出待付款帳單/包裹，選擇支付方式並呼叫 B2                          |        | 未開始   |
| B8  | 支付成功/失敗回饋與狀態更新 | 支付結果回寫 payments 狀態，並更新 packages / bills 的付款狀態                              |        | 未開始   |

---

### 建議實作狀態用語（你們可以自訂）

- `未開始`
- `進行中`
- `已完成`
- `待討論`
- `擱置`
