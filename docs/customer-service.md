# 客服員（customer_service）作業規範 v1

本文件定義客服員的工作範圍、工作清單、異常池處理流程，以及「客戶端狀態顯示」在異常介入後的行為約束。目標是讓客服處理能落地到明確的決策與操作，不產生分支/雙線的追蹤體驗。

---

## 1. 角色與職責

### 1.1 角色
- 客服員：`users.user_class = 'customer_service'`

### 1.2 核心職責
- 回應並審核合約申請：決定是否核准客戶成為合約客戶。
- 處理異常配送事件：對每一筆異常做出決策，並推動後續處理，使包裹回到可控狀態（恢復配送或終止配送）。

---

## 2. 工作清單（Task Board）

客服員的工作清單分為兩類任務：

### 2.1 合約審核任務
- 來源：合約申請（contract application）
- 行為：檢視申請資料 → 核准/拒絕 → 填寫處理備註 → 送出結果

### 2.2 異常處理任務
- 來源：異常池（未結案異常）
- 行為：接案/指派 → 蒐集資訊 → 做出處理決策 → 執行決策（恢復/取消/導向後續處理）→ 結案

---

## 3. 異常池（Exception Pool）與指派

### 3.1 異常池定義
- 異常池 = `package_exceptions.handled = 0` 的集合。

### 3.2 指派規則（MVP）
- 異常進入異常池時，系統會指派一名客服為負責人。
- 目前只有一位客服員時，可採用簡化策略：
  - 直接指派給唯一客服（不需搶單/重新分派 UI）。

> 後續擴充：保留 `assigned_to/assigned_at` 的實作空間，但本版不要求落地（客服人數不是配送流程的決定因素）。

---

## 4. 異常處理流程（客服）

> 異常事件與一致性規則以 `docs/exception-handling.md` 為準；本文件聚焦客服的工作步驟與決策內容。

### 4.1 檢視異常資訊（輸入）
客服對每一筆異常至少需要看到：
- 包裹識別：`tracking_number` / `package_id`
- 異常分類：`reason_code`（需中文顯示）
- 詳細說明：`description`
- 異常位置：節點（`END_*/REG_*/HUB_*`）或車上（`TRUCK_*`）
- 異常時間：`reported_at`
- 相關人員（可選）：申報者角色/身分（driver/warehouse_staff）與聯絡資訊（若存在）

### 4.2 蒐集與溝通（通道）
客服需要具備與客戶/員工的聯絡管道（不限定實作形式）：
- 對客戶：電話、Email、站內訊息（擇一或多個）
- 對員工（司機/倉儲）：內部通訊（擇一）

規範要求：
- 無論採何種通道，客服結案時需能留下「處理摘要」作為稽核依據（對應 `handling_report`）。

### 4.3 做出處理決策（決策樹）
客服需要決定此異常的處理方式（可擴充）：
- **恢復配送（resume）**：確認異常已排除，可回到正常配送流程。
- **取消配送（cancel）**：終止此包裹委託（例如拒收、遺失確定無法找回等）。
- **導向處置（disposition）**：不立刻恢復也不立刻取消，而是安排後續處置（例如送回原處、銷毀、暫置於配送站等待客戶取回、改派至其他站點）。

> 規範決定：導向處置視為「指示」而非新的事件分類，先以客服 `handling_report`（備註）與員工可見的提示落地即可。

### 4.4 執行決策（動作）
客服執行決策時，系統應支援：
- 填寫 `handling_report`（必填）
- 選擇 action（resume/cancel）
- 必要時補充處理位置（location，用於 `exception_resolved` 事件）

處理後續（非立即落地但需在規範中保留）：
- 若涉及賠償、重寄、退款：需建立對帳/理賠流程（暫不在本版實作）
- 若涉及下一移動地、回收/送回：需建立後續任務或站點指引（暫不在本版實作）

---

## 5. 客戶端狀態顯示規範（與異常介入的關係）

### 5.1 顯示由三部分構成
- **過去歷史（History）**：不可修改，只追加（append-only）。
- **現在狀態（Current）**：需即時更新（例如正常綠色 ↔ 異常黃色）。
- **未來預計（Forecast）**：若現在狀態或路徑改變，需重新計算；且保持單一路徑，不產生分支/雙線。

### 5.2 進入配送紀錄（History tab）的規則
配送事件的定義：
- 頭：客戶建立出貨單（created）
- 尾（兩種終端）：
  - 收件者取得包裹並確認（delivered_confirmed，或等效概念）
  - 配送失敗終止（delivery_failed）

進入配送紀錄條件（規範決定）：
- 進入配送紀錄需為「終端狀態」：
  - `delivered`（既有完成）
  - `delivery_failed`（取消終止）
- 若收件者未確認，系統在 **7 天內自動歸類為完成**（視為 delivered 流程的完成判定），使收件者即使不是系統客戶也適用。

> 實作提示（非規範）：可用「新增 delivered_confirmed 事件」或以 delivered_at 時間 + 7 天推導完成，不必回寫歷史事件。

### 5.3 顏色語意
- 正常（綠色）：正常配送中。
- 異常（黃色）：已申報異常，等待客服指引；異常解除後可回到綠色。
- 配送失敗（紅色）：配送已終止（cancel）。包裹應保留在客戶的配送紀錄中，作為歷史紀錄。

### 5.4 不可回寫歷史
- 若當下沒有即時申報異常，系統就視為「尚未異常」照流程繼續。
- 直到異常被申報（包含收件者提出客訴後才補登）才開始呈現黃色；過去已發生的綠色狀態不回溯修改。

### 5.5 單一路徑（不分支）
- 若客服介入導致後續配送計畫改變（例如改派、暫置、送回），客戶端仍只顯示「唯一一條」未來預計路徑（以最新決策為準），避免雙線。

---

## 6. 與異常事件規範的關係

- 異常事件的建立與封鎖規則：`docs/exception-handling.md`
- 客服在異常結案時的資料落點：
  - `package_exceptions.handled = 1`
  - `package_exceptions.handling_report`（必填）
  - `package_events.delivery_status = 'exception_resolved'`

---

## 7. 擴充保留（非必要）

### 7.1 客服指派資料結構
本版不要求落地 `assigned_to/assigned_at`；保留擴充空間即可（單一客服/單一清單模式）。

### 7.2 導向處置（disposition）的落地方式
（規範決定）導向處置先不新增事件/任務表：以客服備註（handling_report）與員工端提示落地即可。

### 7.3 resume/cancel 的配送閉環
（規範決定）
- `resume` 不強制回到倉儲分揀：由客服在 handling_report 指示後續動作（例如留在車上送回原處、移至配送站暫置等）。
- `cancel` 的客戶端呈現為「配送失敗（紅色）」；落地方式以 `docs/exception-handling.md` 的方案 A 為準（寫入 `delivery_failed` 終端事件並使 `packages.status=delivery_failed`）。

### 7.4 聯絡通道
（規範決定）先以「顯示客服電話」為主，不要求建立溝通紀錄或站內訊息系統；是否使用由員工自行決定。
